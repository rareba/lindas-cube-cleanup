
Delete all Cube-version except the newest 2
Open
  Issue created 2 weeks ago by Claudio Di Gallo
A Design paradigm of LINDAS was that we never delete any triples. Reason for this is, you don't kow if your triple (or the subject of it) is actually a object of another tripel. That is something in LINDAS or outside of it "points" to your triple.

This of course has some immediate problems. Updates for one. All pipelines do actually delete the whole graph (which of course is another problem). But for this ticket the problem is Cube-Creator. Especially the Bigger Cubes which sometmes are updated once a month or more over the years the triples amass.

All the Cubes from one Partner are in one graph that has the namespace like this: https://lindas.admin.ch/sfoe/cube for the swiss federal office of energy.

If you make a query on dataset you see that they are inside of the cube all connected: https://s.zazuko.com/x5RfiD (or on trifid: https://energy.ld.admin.ch/.well-known/void)

(Data-architecture offshooot: the well-known/void is not by office/partner but by namespace, that is energy communication or environment. Attribution to namespace is either office (cube-creator) or content of dataset.)

You see there multiple versions. We only want the newest two.

Seems like an easy task. There are two complications: the Cube-structure can be quite complex and differ quite a bit between cubes and maybe between versions. And Querying and especially deleting such complex datastructure.

Probably most effective would be to download the whole graph and do it locally. The other possiblity I have done before is to first only delete observations in chunks because allmost alle the triples are in there.

Now follows a query how to find and delete all triples in a cube: Note this query is a bit dated an i cannot guarantee that it actually really finds all possible shapes of a cube.


PREFIX cube: <https://cube.link/>
PREFIX sh: <http://www.w3.org/ns/shacl#>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>

WITH <https://lindas.admin.ch/foen/cube>
delete {
 ?cube a cube:Cube ;
       cube:observationConstraint ?shape ;
       cube:observationSet ?set ;
       ?p1 ?metaLevel1 .

 ?metaLevel1 ?p2 ?metaLevel2 .
 
 ?shape ?shapeP ?shapeO .
 ?propertyS ?propertyP ?propertyO .
 
 ?set cube:observation ?observationS .
 ?observationS ?observationP ?observationO .
}
WHERE  
{ 
   BIND(<https://environment.ld.admin.ch/foen/ubd000501/10> AS ?cube)
   ?cube  rdf:type  cube:Cube

     { # Cube's direct metadata
       ?cube  ?p1  ?metaLevel1
       OPTIONAL
         { # Second level of metadata in blank nodes
           ?metaLevel1  ?p2  ?metaLevel2
           FILTER isBlank(?metaLevel1)
         }
     }
   UNION
     { # Constraint Shape properties
       ?cube   cube:observationConstraint  ?shape .
       ?shape  ?shapeP               ?shapeO
     }
   UNION
     { # Property Shape properties need to be queried deep to get RDF Lists
       ?cube cube:observationConstraint/sh:property ?property .
       ?property (<>|!<>)* ?propertyS .
       ?propertyS  ?propertyP  ?propertyO
     }
   UNION
     { # Actual observation data
       ?cube     cube:observationSet  ?set .
       ?set      cube:observation     ?observationS .
       ?observationS
                 ?observationP        ?observationO
     }
}
AC
Find out the best option how to delete old versionf for BFE
Run Query to delete what is needed
Find a long term solution to implement into Cube Creator
Testing
Test data available from @silvan.aufdermaur .

Can be tested on TEST.

0 of 3 checklist items completed Â· Edited 2 weeks ago by David Freiburghaus
Attributes
Assignee
None
-
Labels
To Do (max. 10)
Parent
None
Milestone
None
Dates
Start: None

Due: None

Time tracking
Add an  or .
3 Participants
Claudio Di Gallo
David Freiburghaus
Silvan Auf der Maur