<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINDAS Cube Version Cleanup</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="header-content">
            <h1>LINDAS Cube Version Cleanup</h1>
            <p class="subtitle">Demo Tool - Delete old cube versions while preserving the newest 2</p>
        </div>
        <div class="connection-status">
            <div id="fuseki-status" class="status-indicator disconnected">
                <span class="status-dot"></span>
                <span class="status-text">Fuseki: Disconnected</span>
            </div>
        </div>
    </header>

    <nav class="tabs">
        <button class="tab-btn active" data-tab="setup">1. Setup</button>
        <button class="tab-btn" data-tab="import">2. Import Data</button>
        <button class="tab-btn" data-tab="explore">3. Explore Cubes</button>
        <button class="tab-btn" data-tab="cleanup">4. Cleanup</button>
        <button class="tab-btn" data-tab="backups">5. Backups</button>
        <button class="tab-btn" data-tab="docs">6. Documentation</button>
    </nav>

    <main>
        <!-- Setup Tab -->
        <section id="setup" class="tab-content active">
            <div class="card">
                <h2>Fuseki Configuration</h2>
                <p class="description">Configure the connection to your local Apache Fuseki instance.</p>

                <div class="form-group">
                    <label for="fuseki-endpoint">Fuseki Endpoint:</label>
                    <input type="text" id="fuseki-endpoint" value="http://localhost:3030" placeholder="http://localhost:3030">
                </div>

                <div class="form-group">
                    <label for="fuseki-dataset">Dataset Name:</label>
                    <input type="text" id="fuseki-dataset" value="lindas" placeholder="lindas">
                </div>

                <div class="button-group">
                    <button id="btn-check-fuseki" class="btn btn-primary">Check Connection</button>
                    <button id="btn-create-dataset" class="btn btn-secondary">Create Dataset</button>
                </div>

                <div id="fuseki-info" class="info-box hidden"></div>
            </div>

            <div class="card">
                <h2>How It Works</h2>
                <div class="workflow-steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h3>Import Data</h3>
                            <p>Download cube data from LINDAS and import it into your local Fuseki instance for safe testing.</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h3>Explore Cubes</h3>
                            <p>View all cubes and their versions. Identify which cubes have more than 2 versions.</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h3>Preview Deletions</h3>
                            <p>See exactly which versions will be deleted and how many triples are affected.</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h3>Execute Cleanup</h3>
                            <p>Delete old versions in a controlled manner, keeping only the newest 2 versions.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Import Tab -->
        <section id="import" class="tab-content">
            <div class="card">
                <h2>Import Data from LINDAS</h2>
                <p class="description">Download cube data from LINDAS and import it into your local Fuseki instance.</p>

                <div class="form-group">
                    <label for="lindas-graph">LINDAS Graph URI:</label>
                    <input type="text" id="lindas-graph" value="https://lindas.admin.ch/sfoe/cube" placeholder="https://lindas.admin.ch/sfoe/cube">
                </div>

                <div class="button-group">
                    <button id="btn-search-graphs" class="btn btn-secondary">Search Graphs</button>
                    <button id="btn-list-cubes" class="btn btn-primary">List Available Cubes</button>
                </div>

                <div id="graph-search-results" class="hidden">
                    <h3>Available Graphs</h3>
                    <div id="graph-list" class="scrollable-list"></div>
                </div>
            </div>

            <div class="card" id="cube-import-section">
                <h2>Select Cubes to Import</h2>
                <p class="description">Select specific cubes to import for testing, or import a sample.</p>

                <div id="cube-list-container" class="scrollable-list">
                    <p class="placeholder-text">Click "List Available Cubes" to see cubes from LINDAS</p>
                </div>

                <div class="button-group">
                    <button id="btn-import-selected" class="btn btn-primary" disabled>Import Selected Cubes</button>
                    <button id="btn-import-sample" class="btn btn-secondary">Import Sample (co2wirkung)</button>
                </div>

                <div id="import-progress" class="progress-container hidden">
                    <div class="progress-bar">
                        <div id="import-progress-fill" class="progress-fill"></div>
                    </div>
                    <p id="import-status" class="status-text"></p>
                </div>
            </div>
        </section>

        <!-- Explore Tab -->
        <section id="explore" class="tab-content">
            <div class="card">
                <h2>Local Cube Explorer</h2>
                <p class="description">View cubes imported into your local Fuseki instance.</p>

                <div class="form-group">
                    <label for="local-graph">Graph to Explore:</label>
                    <input type="text" id="local-graph" value="https://lindas.admin.ch/sfoe/cube" placeholder="https://lindas.admin.ch/sfoe/cube">
                </div>

                <div class="button-group">
                    <button id="btn-load-local-cubes" class="btn btn-primary">Load Local Cubes</button>
                    <button id="btn-count-triples" class="btn btn-secondary">Count Total Triples</button>
                </div>

                <div id="triple-count-info" class="info-box hidden"></div>
            </div>

            <div class="card">
                <h2>Cubes with Multiple Versions</h2>
                <p class="description">These cubes have more than 2 versions and are candidates for cleanup.</p>

                <div id="multi-version-cubes" class="table-container">
                    <p class="placeholder-text">Load cubes to see version information</p>
                </div>
            </div>

            <div class="card">
                <h2>All Cube Versions</h2>
                <div id="all-cube-versions" class="table-container">
                    <p class="placeholder-text">Load cubes to see all versions</p>
                </div>
            </div>
        </section>

        <!-- Cleanup Tab -->
        <section id="cleanup" class="tab-content">
            <div class="card">
                <h2>Version Cleanup Preview</h2>
                <p class="description">Preview which versions will be deleted (keeping newest 2 per cube).</p>

                <div class="form-group">
                    <label for="cleanup-graph">Graph:</label>
                    <input type="text" id="cleanup-graph" value="https://lindas.admin.ch/sfoe/cube" placeholder="https://lindas.admin.ch/sfoe/cube">
                </div>

                <button id="btn-identify-deletions" class="btn btn-primary">Identify Versions to Delete</button>

                <div id="deletion-preview" class="table-container">
                    <p class="placeholder-text">Click "Identify Versions to Delete" to see the cleanup plan</p>
                </div>
            </div>

            <div class="card" id="deletion-detail-card" style="display: none;">
                <h2>Deletion Details</h2>
                <p class="description">Select a cube version below to see how many triples will be deleted.</p>

                <div id="cubes-to-delete" class="scrollable-list"></div>

                <div id="selected-cube-preview" class="hidden">
                    <h3>Selected Cube: <span id="selected-cube-name"></span></h3>
                    <div id="triple-breakdown" class="stats-grid"></div>
                </div>
            </div>

            <div class="card" id="deletion-execution-card" style="display: none;">
                <h2>Execute Deletion</h2>
                <p class="description warning">Warning: This will permanently delete the selected cube version from your local Fuseki instance.</p>

                <div id="deletion-queue" class="scrollable-list"></div>

                <div class="button-group">
                    <button id="btn-delete-selected" class="btn btn-danger" disabled>Delete Selected Cube</button>
                    <button id="btn-delete-all-old" class="btn btn-danger" disabled>Delete All Old Versions</button>
                </div>

                <div id="deletion-progress" class="progress-container hidden">
                    <div class="progress-bar">
                        <div id="deletion-progress-fill" class="progress-fill"></div>
                    </div>
                    <p id="deletion-status" class="status-text"></p>
                </div>

                <div id="deletion-log" class="log-container hidden">
                    <h3>Deletion Log</h3>
                    <pre id="log-content"></pre>
                </div>
            </div>

            <div class="card" id="deletion-summary-card" style="display: none;">
                <h2>Deletion Summary</h2>
                <div id="deletion-summary" class="summary-container">
                    <div class="summary-header">
                        <div class="summary-icon success-icon">&#10003;</div>
                        <div class="summary-title">
                            <h3>Cleanup Complete</h3>
                            <p id="summary-timestamp"></p>
                        </div>
                    </div>
                    <div class="summary-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="summary-versions-deleted">0</div>
                            <div class="stat-label">Versions Deleted</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="summary-triples-deleted">0</div>
                            <div class="stat-label">Triples Removed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="summary-versions-kept">0</div>
                            <div class="stat-label">Versions Kept</div>
                        </div>
                    </div>
                    <div class="summary-details">
                        <h4>Deleted Versions</h4>
                        <div id="summary-deleted-list" class="deleted-list"></div>
                        <h4>Preserved Versions</h4>
                        <div id="summary-kept-list" class="kept-list"></div>
                    </div>
                    <div class="summary-actions">
                        <p class="backup-notice">A backup was created and will be available for 7 days.</p>
                        <button id="btn-view-backup" class="btn btn-secondary">View Backup</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Backups Tab -->
        <section id="backups" class="tab-content">
            <div class="card">
                <h2>Backup Management</h2>
                <p class="description">View and restore deleted cube versions. Backups are automatically deleted after 7 days.</p>

                <button id="btn-refresh-backups" class="btn btn-primary">Refresh Backup List</button>

                <div id="backup-list-container" class="table-container">
                    <p class="placeholder-text">Click "Refresh Backup List" to see available backups</p>
                </div>
            </div>

            <div class="card" id="restore-preview-card" style="display: none;">
                <h2>Restore Preview</h2>
                <p class="description">Review the backup before restoring.</p>

                <div id="restore-preview-info" class="info-box"></div>

                <div class="button-group">
                    <button id="btn-restore-backup" class="btn btn-primary">Restore This Backup</button>
                    <button id="btn-delete-backup" class="btn btn-danger">Delete Backup</button>
                </div>

                <div id="restore-progress" class="progress-container hidden">
                    <div class="progress-bar">
                        <div id="restore-progress-fill" class="progress-fill"></div>
                    </div>
                    <p id="restore-status" class="status-text"></p>
                </div>
            </div>
        </section>

        <!-- Documentation Tab -->
        <section id="docs" class="tab-content">
            <div class="card">
                <h2>How the Cleanup Process Works</h2>
                <p class="description">This page explains the SPARQL queries and logic used to identify and delete old cube versions.</p>
            </div>

            <div class="card">
                <h2>Step 1: Version Detection</h2>
                <div class="doc-section">
                    <h3>Understanding Cube URIs</h3>
                    <p>LINDAS cubes follow a versioned URI pattern:</p>
                    <pre class="code-block">https://energy.ld.admin.ch/sfoe/{cube_name}/{version_number}</pre>
                    <p>For example:</p>
                    <ul class="doc-list">
                        <li><code>...bfe_ogd18_gebaeudeprogramm_co2wirkung/7</code> - Version 7</li>
                        <li><code>...bfe_ogd18_gebaeudeprogramm_co2wirkung/1</code> - Version 1</li>
                    </ul>

                    <h3>Version Extraction Query</h3>
                    <p>The system extracts version numbers using regex pattern matching:</p>
                    <pre class="code-block sparql">BIND(REPLACE(STR(?cube), "^.*/([^/]+)/([0-9]+)$", "$2") AS ?version)
BIND(REPLACE(STR(?cube), "^(.*/[^/]+)/[0-9]+$", "$1") AS ?baseCube)</pre>
                    <p><strong>Logic:</strong> The regex captures the numeric suffix as the version and everything before it as the base cube identifier.</p>
                </div>
            </div>

            <div class="card">
                <h2>Step 2: Version Counting</h2>
                <div class="doc-section">
                    <h3>Grouping by Base Cube</h3>
                    <p>All cube versions are grouped by their base URI to count how many versions exist:</p>
                    <pre class="code-block sparql">SELECT ?baseCube (COUNT(DISTINCT ?cube) AS ?versionCount)
WHERE {
  ?cube a cube:Cube .
  # ... version extraction ...
}
GROUP BY ?baseCube
HAVING (COUNT(DISTINCT ?cube) > 2)</pre>
                    <p><strong>Logic:</strong> The <code>HAVING</code> clause filters to show only cubes with more than 2 versions (cleanup candidates).</p>

                    <div class="example-box">
                        <h4>Example Result</h4>
                        <table class="doc-table">
                            <tr><th>Base Cube</th><th>Version Count</th><th>Action</th></tr>
                            <tr><td>co2wirkung</td><td>7</td><td>Needs cleanup</td></tr>
                            <tr><td>other_cube</td><td>2</td><td>OK (not shown)</td></tr>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Step 3: Ranking Algorithm</h2>
                <div class="doc-section">
                    <h3>How Versions Are Ranked</h3>
                    <p>The core algorithm determines which versions to keep or delete:</p>
                    <pre class="code-block">Rank = (Number of newer versions) + 1</pre>

                    <div class="ranking-visual">
                        <h4>Ranking Example (7 versions)</h4>
                        <table class="doc-table ranking-table">
                            <tr><th>Version</th><th>Newer Versions</th><th>Rank</th><th>Action</th></tr>
                            <tr class="keep-row"><td>7</td><td>0</td><td>1</td><td class="action-keep">KEEP</td></tr>
                            <tr class="keep-row"><td>6</td><td>1 (v7)</td><td>2</td><td class="action-keep">KEEP</td></tr>
                            <tr class="delete-row"><td>5</td><td>2 (v6, v7)</td><td>3</td><td class="action-delete">DELETE</td></tr>
                            <tr class="delete-row"><td>4</td><td>3</td><td>4</td><td class="action-delete">DELETE</td></tr>
                            <tr class="delete-row"><td>3</td><td>4</td><td>5</td><td class="action-delete">DELETE</td></tr>
                            <tr class="delete-row"><td>2</td><td>5</td><td>6</td><td class="action-delete">DELETE</td></tr>
                            <tr class="delete-row"><td>1</td><td>6</td><td>7</td><td class="action-delete">DELETE</td></tr>
                        </table>
                    </div>

                    <h3>SPARQL Implementation</h3>
                    <pre class="code-block sparql">SELECT ?cube ?version (COUNT(?newerCube) + 1 AS ?rank)
WHERE {
  ?cube a cube:Cube .
  OPTIONAL {
    ?newerCube a cube:Cube .
    FILTER(?newerBaseCube = ?baseCube && ?newerVersion > ?version)
  }
}
GROUP BY ?cube ?version
HAVING ((COUNT(?newerCube) + 1) > 2)  -- Only return DELETE candidates</pre>
                    <p><strong>Logic:</strong> For each cube, count how many other cubes of the same base have a higher version number. Add 1 to get the rank. Versions with rank > 2 are marked for deletion.</p>
                </div>
            </div>

            <div class="card">
                <h2>Step 4: Deletion Process</h2>
                <div class="doc-section">
                    <h3>Cube Structure</h3>
                    <p>A cube consists of multiple components that must all be deleted:</p>
                    <div class="structure-diagram">
                        <pre class="code-block">cube:Cube
  +-- Metadata (title, dates, creator)
  |     +-- Blank nodes (nested properties)
  |
  +-- cube:observationConstraint --> SHACL Shape
  |     +-- sh:property --> Property shapes
  |           +-- sh:in --> RDF lists
  |
  +-- cube:observationSet --> Observation container
        +-- cube:observation --> Data points (many)</pre>
                    </div>

                    <h3>Three-Step Chunked Deletion</h3>
                    <p>To avoid timeouts with large cubes, deletion is performed in three steps:</p>

                    <div class="deletion-steps">
                        <div class="deletion-step">
                            <div class="step-badge">1</div>
                            <div class="step-detail">
                                <h4>Delete Observations</h4>
                                <p>Remove observation data in chunks of 50,000 triples. Repeat until all observations are deleted.</p>
                                <pre class="code-block sparql">DELETE { ?obs ?p ?o }
WHERE {
  &lt;cubeUri&gt; cube:observationSet/cube:observation ?obs .
  ?obs ?p ?o .
} LIMIT 50000</pre>
                            </div>
                        </div>

                        <div class="deletion-step">
                            <div class="step-badge">2</div>
                            <div class="step-detail">
                                <h4>Delete Observation Links</h4>
                                <p>Remove the <code>cube:observation</code> property connections.</p>
                                <pre class="code-block sparql">DELETE { ?set cube:observation ?obs }
WHERE {
  &lt;cubeUri&gt; cube:observationSet ?set .
  ?set cube:observation ?obs .
}</pre>
                            </div>
                        </div>

                        <div class="deletion-step">
                            <div class="step-badge">3</div>
                            <div class="step-detail">
                                <h4>Delete Metadata and Shapes</h4>
                                <p>Remove cube metadata, SHACL shapes, and the observation set container.</p>
                                <pre class="code-block sparql">DELETE { ?s ?p ?o }
WHERE {
  { &lt;cubeUri&gt; ?p ?o . BIND(&lt;cubeUri&gt; AS ?s) }
  UNION
  { &lt;cubeUri&gt; cube:observationConstraint ?shape . ?shape ?p ?o . BIND(?shape AS ?s) }
  UNION
  { ... property shapes, blank nodes, etc. }
}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Step 5: Backup and Rollback</h2>
                <div class="doc-section">
                    <h3>Automatic Backup</h3>
                    <p>Before deletion, the system automatically creates a backup:</p>
                    <ol class="doc-list numbered">
                        <li>Export all triples for the cube using a CONSTRUCT query</li>
                        <li>Save as N-Triples file with timestamp</li>
                        <li>Store metadata (cube URI, graph, deletion date)</li>
                    </ol>

                    <h3>Restore Process</h3>
                    <p>To restore a deleted cube:</p>
                    <ol class="doc-list numbered">
                        <li>Load the backup N-Triples file</li>
                        <li>Re-import into the original graph</li>
                        <li>Verify restoration with a count query</li>
                    </ol>

                    <h3>Retention Policy</h3>
                    <p>Backups are automatically deleted after <strong>7 days</strong> to manage storage.</p>
                </div>
            </div>

            <div class="card">
                <h2>Query Flow Diagram</h2>
                <div class="doc-section">
                    <div class="flow-diagram">
                        <div class="flow-step">
                            <div class="flow-box">List All Versions<br><small>Query 01</small></div>
                            <div class="flow-arrow">&#8595;</div>
                        </div>
                        <div class="flow-step">
                            <div class="flow-box">Count Per Cube<br><small>Query 02</small></div>
                            <div class="flow-arrow">&#8595;</div>
                        </div>
                        <div class="flow-step">
                            <div class="flow-box">Rank & Identify<br><small>Query 03</small></div>
                            <div class="flow-arrow">&#8595;</div>
                        </div>
                        <div class="flow-step flow-branch">
                            <div class="flow-box-left">Create Backup<br><small>CONSTRUCT</small></div>
                            <div class="flow-box-right">Preview Triples<br><small>COUNT</small></div>
                        </div>
                        <div class="flow-step">
                            <div class="flow-arrow">&#8595;</div>
                            <div class="flow-box danger">Execute Deletion<br><small>3-Step DELETE</small></div>
                            <div class="flow-arrow">&#8595;</div>
                        </div>
                        <div class="flow-step">
                            <div class="flow-box success">Verify & Summary</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>LINDAS Cube Version Cleanup - Demo Tool</p>
        <p class="small">Preserves the newest 2 versions of each cube, deletes older versions</p>
    </footer>

    <script src="app.js"></script>
</body>
</html>
