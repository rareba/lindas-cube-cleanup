<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINDAS Cube Manager</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Main Layout Container -->
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1 class="app-title">LINDAS<br><span>Cube Manager</span></h1>
                <p class="app-version">v2.0</p>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Mode</div>
                    <div class="mode-toggle" id="mode-toggle">
                        <button class="mode-btn active" data-mode="dryrun" title="Preview changes without executing">
                            <span class="mode-icon">&#128269;</span>
                            <span class="mode-label">Dry Run</span>
                        </button>
                        <button class="mode-btn" data-mode="execute" title="Execute real deletions">
                            <span class="mode-icon">&#9889;</span>
                            <span class="mode-label">Execute</span>
                        </button>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a href="#" class="nav-item active" data-section="connection">
                        <span class="nav-icon">&#9881;</span>
                        <span class="nav-text">Connection</span>
                    </a>
                    <a href="#" class="nav-item" data-section="download">
                        <span class="nav-icon">&#8615;</span>
                        <span class="nav-text">Download Data</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Tools</div>
                    <a href="#" class="nav-item" data-section="wizard">
                        <span class="nav-icon">&#10052;</span>
                        <span class="nav-text">Deletion Wizard</span>
                    </a>
                    <a href="#" class="nav-item" data-section="query-editor">
                        <span class="nav-icon">&#128196;</span>
                        <span class="nav-text">Query Editor</span>
                    </a>
                    <a href="#" class="nav-item" data-section="backups">
                        <span class="nav-icon">&#128451;</span>
                        <span class="nav-text">Backups</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Help</div>
                    <a href="#" class="nav-item" data-section="documentation">
                        <span class="nav-icon">&#128218;</span>
                        <span class="nav-text">Documentation</span>
                    </a>
                    <a href="#" class="nav-item" data-section="installation">
                        <span class="nav-icon">&#128295;</span>
                        <span class="nav-text">Installation Guide</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="connection-status-sidebar" id="connection-status-sidebar">
                    <span class="status-dot disconnected"></span>
                    <span class="status-label">Disconnected</span>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Header -->
            <header class="content-header" id="content-header">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebar-toggle" title="Toggle sidebar">&#9776;</button>
                    <h2 class="page-title" id="page-title">Connection Setup</h2>
                </div>
                <div class="header-right">
                    <div class="mode-indicator" id="header-mode-indicator">
                        <span class="mode-badge dryrun">DRY RUN</span>
                    </div>
                    <div class="triplestore-info" id="header-triplestore-info">
                        <span class="triplestore-type">Not connected</span>
                    </div>
                </div>
            </header>

            <!-- Content Sections -->
            <div class="content-wrapper">
                <!-- Connection Section -->
                <section id="section-connection" class="content-section active">
                    <div class="section-intro">
                        <p>Configure your connection to a local or remote SPARQL triplestore.</p>
                    </div>

                    <!-- Mode Info Banner -->
                    <div class="info-banner mode-banner" id="mode-info-banner">
                        <div class="info-icon">&#128190;</div>
                        <div class="info-content">
                            <strong>Offline Mode</strong>
                            <p>Connect to a local triplestore instance. Download data from LINDAS and work safely without affecting production data.</p>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Triplestore Configuration</h3>

                        <div class="form-row">
                            <div class="form-group half">
                                <label for="triplestore-type">Triplestore Type</label>
                                <select id="triplestore-type" class="select-input">
                                    <option value="fuseki">Apache Fuseki</option>
                                    <option value="stardog">Stardog</option>
                                    <option value="graphdb">GraphDB</option>
                                </select>
                            </div>
                            <div class="form-group half">
                                <label for="connection-mode">Connection</label>
                                <select id="connection-mode" class="select-input">
                                    <option value="local">Local Instance</option>
                                    <option value="remote">Remote Server / Cloud</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="endpoint-url">Endpoint URL</label>
                            <input type="text" id="endpoint-url" value="http://localhost:3030" placeholder="http://localhost:3030">
                            <small class="form-hint" id="endpoint-hint">Default endpoint for Apache Fuseki local instance</small>
                        </div>

                        <div class="form-row" id="dataset-row">
                            <div class="form-group full">
                                <label for="fuseki-dataset">Dataset Name</label>
                                <input type="text" id="fuseki-dataset" value="lindas" placeholder="lindas">
                            </div>
                        </div>

                        <div class="form-row hidden" id="stardog-row">
                            <div class="form-group full">
                                <label for="stardog-database">Database Name</label>
                                <input type="text" id="stardog-database" value="lindas" placeholder="mydb">
                            </div>
                        </div>

                        <div class="form-row hidden" id="graphdb-row">
                            <div class="form-group full">
                                <label for="graphdb-repository">Repository Name</label>
                                <input type="text" id="graphdb-repository" value="test" placeholder="test">
                            </div>
                        </div>

                        <div class="form-row hidden" id="auth-row">
                            <div class="form-group half">
                                <label for="auth-username">Username</label>
                                <input type="text" id="auth-username" placeholder="admin">
                            </div>
                            <div class="form-group half">
                                <label for="auth-password">Password</label>
                                <input type="password" id="auth-password" placeholder="password">
                            </div>
                        </div>

                        <div class="button-group">
                            <button id="btn-test-connection" class="btn btn-primary">Test Connection</button>
                            <button id="btn-create-dataset" class="btn btn-secondary">Create Dataset</button>
                        </div>

                        <div id="connection-result" class="result-box hidden"></div>
                    </div>

                    <!-- Quick Setup Cards -->
                    <div class="quick-setup-grid">
                        <div class="setup-card" data-setup="fuseki">
                            <div class="setup-card-header">
                                <span class="setup-icon">&#9670;</span>
                                <h4>Apache Fuseki</h4>
                            </div>
                            <p>Free, open-source SPARQL server</p>
                            <code>docker run -p 3030:3030 stain/jena-fuseki</code>
                            <button class="btn btn-small btn-outline" data-preset="fuseki">Use Fuseki</button>
                        </div>
                        <div class="setup-card" data-setup="stardog">
                            <div class="setup-card-header">
                                <span class="setup-icon">&#9733;</span>
                                <h4>Stardog</h4>
                            </div>
                            <p>Enterprise knowledge graph platform</p>
                            <code>docker run -p 5820:5820 stardog/stardog</code>
                            <button class="btn btn-small btn-outline" data-preset="stardog">Use Stardog</button>
                        </div>
                        <div class="setup-card" data-setup="graphdb">
                            <div class="setup-card-header">
                                <span class="setup-icon">&#9678;</span>
                                <h4>GraphDB</h4>
                            </div>
                            <p>RDF database with reasoning</p>
                            <code>docker run -p 7200:7200 ontotext/graphdb:free</code>
                            <button class="btn btn-small btn-outline" data-preset="graphdb">Use GraphDB</button>
                        </div>
                    </div>
                </section>

                <!-- Download Data Section (Offline Mode Only) -->
                <section id="section-download" class="content-section">
                    <div class="section-intro">
                        <p>Download cube data from LINDAS production environments to your local triplestore.</p>
                    </div>

                    <div class="card">
                        <h3>Select LINDAS Environment</h3>

                        <div class="environment-selector">
                            <label class="env-option">
                                <input type="radio" name="lindas-env" value="https://lindas.admin.ch" checked>
                                <div class="env-card">
                                    <span class="env-icon">&#127760;</span>
                                    <div class="env-info">
                                        <strong>Production (ld.admin.ch)</strong>
                                        <span>https://lindas.admin.ch</span>
                                    </div>
                                    <span class="env-badge production">PROD</span>
                                </div>
                            </label>
                            <label class="env-option">
                                <input type="radio" name="lindas-env" value="https://int.lindas.admin.ch">
                                <div class="env-card">
                                    <span class="env-icon">&#128295;</span>
                                    <div class="env-info">
                                        <strong>Integration (int.ld.admin.ch)</strong>
                                        <span>https://int.lindas.admin.ch</span>
                                    </div>
                                    <span class="env-badge integration">INT</span>
                                </div>
                            </label>
                            <label class="env-option">
                                <input type="radio" name="lindas-env" value="https://test.lindas.admin.ch">
                                <div class="env-card">
                                    <span class="env-icon">&#128248;</span>
                                    <div class="env-info">
                                        <strong>Test (test.ld.admin.ch)</strong>
                                        <span>https://test.lindas.admin.ch</span>
                                    </div>
                                    <span class="env-badge test">TEST</span>
                                </div>
                            </label>
                            <label class="env-option">
                                <input type="radio" name="lindas-env" value="custom">
                                <div class="env-card">
                                    <span class="env-icon">&#9998;</span>
                                    <div class="env-info">
                                        <strong>Custom URL</strong>
                                        <input type="text" id="custom-lindas-url" class="inline-input" placeholder="https://your-sparql-endpoint.com/query" disabled>
                                    </div>
                                    <span class="env-badge custom">CUSTOM</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Select Graph to Download</h3>

                        <div class="form-group">
                            <label for="download-graph-select">Available Graphs</label>
                            <div class="input-with-button">
                                <select id="download-graph-select" class="select-input">
                                    <option value="">-- Click "Load Graphs" to see available graphs --</option>
                                </select>
                                <button id="btn-load-graphs" class="btn btn-secondary">Load Graphs</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="download-graph-manual">Or enter graph URI manually</label>
                            <input type="text" id="download-graph-manual" value="https://lindas.admin.ch/sfoe/cube" placeholder="https://lindas.admin.ch/sfoe/cube">
                        </div>

                        <div id="graph-info" class="info-box hidden"></div>
                    </div>

                    <div class="card">
                        <h3>Download Options</h3>

                        <div class="download-options">
                            <div class="download-option primary">
                                <h4>Download All Cubes from Graph</h4>
                                <p>Downloads all cube versions from the selected graph with rate limiting to prevent overloading LINDAS.</p>
                                <button id="btn-download-all" class="btn btn-primary btn-large">Download All Cubes</button>
                            </div>
                            <div class="download-option">
                                <h4>Download Sample Data</h4>
                                <p>Quick download of sample cubes for testing (co2wirkung - 7 versions).</p>
                                <button id="btn-download-sample" class="btn btn-secondary">Download Sample</button>
                            </div>
                        </div>

                        <div id="download-progress" class="progress-container hidden">
                            <div class="progress-header">
                                <span id="download-step">Preparing...</span>
                                <span id="download-counter">0 / 0</span>
                            </div>
                            <div class="progress-bar">
                                <div id="download-progress-fill" class="progress-fill"></div>
                            </div>
                            <div class="progress-details">
                                <p id="download-status" class="status-text"></p>
                                <p id="download-current" class="current-item"></p>
                            </div>
                            <div id="download-rate-limit" class="rate-limit-notice hidden">
                                <span class="rate-icon">&#8987;</span> Rate limiting: waiting before next download...
                            </div>
                        </div>

                        <div id="download-summary" class="summary-box hidden">
                            <h4>Download Complete</h4>
                            <div class="summary-stats">
                                <div class="stat">
                                    <span class="stat-value" id="summary-downloaded">0</span>
                                    <span class="stat-label">Cubes Downloaded</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-value" id="summary-triples">0</span>
                                    <span class="stat-label">Triples Added</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-value" id="summary-errors">0</span>
                                    <span class="stat-label">Errors</span>
                                </div>
                            </div>
                            <button id="btn-go-to-wizard" class="btn btn-primary">Continue to Deletion Wizard</button>
                        </div>
                    </div>
                </section>

                <!-- Deletion Wizard Section -->
                <section id="section-wizard" class="content-section">
                    <div class="section-intro">
                        <p>Step-by-step wizard to identify and delete old cube versions while keeping the newest <span id="versions-to-keep-display">2</span>.</p>
                    </div>

                    <!-- Wizard Steps Indicator -->
                    <div class="wizard-steps">
                        <div class="wizard-step active" data-step="1">
                            <span class="step-number">1</span>
                            <span class="step-label">Select Graph</span>
                        </div>
                        <div class="wizard-step" data-step="2">
                            <span class="step-number">2</span>
                            <span class="step-label">Explore Cubes</span>
                        </div>
                        <div class="wizard-step" data-step="3">
                            <span class="step-number">3</span>
                            <span class="step-label">Preview Deletions</span>
                        </div>
                        <div class="wizard-step" data-step="4">
                            <span class="step-number">4</span>
                            <span class="step-label">Execute Cleanup</span>
                        </div>
                        <div class="wizard-step" data-step="5">
                            <span class="step-number">5</span>
                            <span class="step-label">Summary</span>
                        </div>
                    </div>

                    <!-- Wizard Step Contents -->
                    <div class="wizard-content">
                        <!-- Step 1: Select Graph -->
                        <div class="wizard-panel active" id="wizard-step-1">
                            <div class="card">
                                <h3>Step 1: Select Graph to Clean</h3>
                                <p class="description">Choose the graph containing cube data to analyze.</p>

                                <div class="form-group">
                                    <label for="wizard-graph">Graph URI</label>
                                    <input type="text" id="wizard-graph" value="https://lindas.admin.ch/sfoe/cube" placeholder="https://lindas.admin.ch/sfoe/cube">
                                </div>

                                <div class="form-group">
                                    <label for="versions-to-keep">Versions to Keep</label>
                                    <input type="number" id="versions-to-keep" value="2" min="1" max="10" style="width: 80px;">
                                    <span class="hint">Number of newest versions to preserve per cube (default: 2)</span>
                                </div>

                                <div class="button-group">
                                    <button id="btn-wizard-load-graph" class="btn btn-primary">Load Graph</button>
                                </div>

                                <div id="wizard-graph-info" class="info-box hidden"></div>
                            </div>
                        </div>

                        <!-- Step 2: Explore Cubes -->
                        <div class="wizard-panel" id="wizard-step-2">
                            <div class="card">
                                <h3>Step 2: Explore Cube Versions</h3>
                                <p class="description">View all cubes and their versions in the selected graph.</p>

                                <div id="wizard-cubes-summary" class="stats-grid"></div>

                                <div id="wizard-multi-version" class="table-container">
                                    <h4>Cubes with Multiple Versions (Cleanup Candidates)</h4>
                                    <div id="multi-version-table"></div>
                                </div>

                                <div id="wizard-all-versions" class="table-container collapsed">
                                    <h4>All Cube Versions <button class="btn btn-small btn-outline toggle-btn">Show All</button></h4>
                                    <div id="all-versions-table"></div>
                                </div>

                                <div class="button-group">
                                    <button id="btn-wizard-back-1" class="btn btn-secondary">Back</button>
                                    <button id="btn-wizard-next-2" class="btn btn-primary">Continue to Preview</button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Preview Deletions -->
                        <div class="wizard-panel" id="wizard-step-3">
                            <div class="card">
                                <h3>Step 3: Select Cubes to Delete</h3>
                                <p class="description">Select which cube versions to delete (keeping newest <span id="preview-versions-keep">2</span> per cube). All are selected by default.</p>

                                <div id="wizard-deletion-preview" class="deletion-preview">
                                    <div class="preview-legend">
                                        <span class="legend-item keep"><span class="badge badge-keep">KEEP</span> Newest versions</span>
                                        <span class="legend-item delete"><span class="badge badge-delete">DELETE</span> Older versions</span>
                                    </div>
                                    <div class="selection-controls">
                                        <label class="checkbox-label select-all-label">
                                            <input type="checkbox" id="select-all-cubes" checked>
                                            <span>Select All Cubes</span>
                                        </label>
                                        <span id="selected-count" class="selected-count">0 of 0 cubes selected</span>
                                    </div>
                                    <div id="deletion-preview-table"></div>
                                </div>

                                <div id="wizard-deletion-stats" class="stats-grid"></div>

                                <div class="button-group">
                                    <button id="btn-wizard-back-2" class="btn btn-secondary">Back</button>
                                    <button id="btn-wizard-next-3" class="btn btn-danger">Proceed to Deletion</button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Execute Cleanup -->
                        <div class="wizard-panel" id="wizard-step-4">
                            <div class="card">
                                <h3>Step 4: Execute Cleanup</h3>

                                <div class="warning-banner">
                                    <span class="warning-icon">&#9888;</span>
                                    <div class="warning-content">
                                        <strong>Warning: This action cannot be undone!</strong>
                                        <p>A backup will be created before deletion, but please make sure you have verified the deletion preview.</p>
                                    </div>
                                </div>

                                <div id="wizard-deletion-queue" class="deletion-queue">
                                    <h4>Cubes to Delete</h4>
                                    <div id="deletion-queue-list"></div>
                                </div>

                                <div class="form-group checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="include-metadata-backup" checked>
                                        <span>Include metadata in backup (default: enabled)</span>
                                        <span class="hint">Cube properties, SHACL shapes, and structural information. Disabling backs up observations only.</span>
                                    </label>
                                </div>

                                <div class="form-group checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="include-orphans-backup" checked>
                                        <span>Include orphan triples in backup (default: enabled)</span>
                                        <span class="hint">Orphan triples are data linked to deleted cubes that may be unused</span>
                                    </label>
                                </div>

                                <div class="form-group checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="cleanup-orphans" checked>
                                        <span>Clean up orphan triples after deletion (default: enabled)</span>
                                        <span class="hint">Removes orphaned observation sets and SHACL shapes</span>
                                    </label>
                                </div>

                                <div class="form-group checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="confirm-deletion">
                                        <span>I understand that this will permanently delete the selected cube versions</span>
                                    </label>
                                </div>

                                <div class="button-group">
                                    <button id="btn-wizard-back-3" class="btn btn-secondary">Back</button>
                                    <button id="btn-execute-deletion" class="btn btn-danger" disabled>Execute Deletion</button>
                                </div>

                                <div id="deletion-progress" class="progress-container hidden">
                                    <div class="progress-header">
                                        <span id="deletion-step">Preparing...</span>
                                        <span id="deletion-counter">0 / 0</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div id="deletion-progress-fill" class="progress-fill"></div>
                                    </div>
                                    <p id="deletion-status" class="status-text"></p>
                                </div>

                                <div id="deletion-log" class="log-container hidden">
                                    <h4>Deletion Log</h4>
                                    <pre id="log-content"></pre>
                                </div>
                            </div>
                        </div>

                        <!-- Step 5: Summary -->
                        <div class="wizard-panel" id="wizard-step-5">
                            <div class="card">
                                <h3>Step 5: Cleanup Summary</h3>

                                <div class="summary-header success">
                                    <span class="summary-icon">&#10003;</span>
                                    <div>
                                        <h4>Cleanup Complete!</h4>
                                        <p id="summary-timestamp"></p>
                                    </div>
                                </div>

                                <div id="wizard-summary-stats" class="stats-grid"></div>

                                <div id="wizard-summary-details" class="summary-details">
                                    <div class="detail-section">
                                        <h4>Deleted Versions</h4>
                                        <div id="summary-deleted-list"></div>
                                    </div>
                                    <div class="detail-section">
                                        <h4>Preserved Versions</h4>
                                        <div id="summary-kept-list"></div>
                                    </div>
                                </div>

                                <div class="backup-notice">
                                    <span class="notice-icon">&#128451;</span>
                                    <p>Backups have been created and will be available for 7 days. <a href="#" id="view-backups-link">View Backups</a></p>
                                </div>

                                <div class="button-group">
                                    <button id="btn-wizard-restart" class="btn btn-primary">Start New Cleanup</button>
                                    <button id="btn-wizard-export-report" class="btn btn-secondary">Export Report</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Query Editor Section -->
                <section id="section-query-editor" class="content-section">
                    <div class="section-intro">
                        <p>Execute SPARQL queries directly against your triplestore.</p>
                    </div>

                    <div class="card">
                        <h3>Query Configuration</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="query-graph-uri">Graph URI</label>
                                <div class="input-with-button">
                                    <input type="text" id="query-graph-uri" value="https://lindas.admin.ch/sfoe/cube" placeholder="https://lindas.admin.ch/sfoe/cube">
                                    <button id="btn-browse-graphs" class="btn btn-secondary btn-small">Browse</button>
                                </div>
                                <select id="query-graph-dropdown" class="dropdown-select hidden">
                                    <option value="">-- Select a graph --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="query-cube-uri">Cube URI (for templates)</label>
                                <div class="input-with-button">
                                    <input type="text" id="query-cube-uri" placeholder="Optional: for cube-specific templates">
                                    <button id="btn-browse-cubes" class="btn btn-secondary btn-small">Browse</button>
                                </div>
                                <select id="query-cube-dropdown" class="dropdown-select hidden">
                                    <option value="">-- Select a cube --</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="query-template">Query Template</label>
                            <select id="query-template" class="select-input">
                                <option value="custom">Custom Query</option>
                                <optgroup label="Read Queries">
                                    <option value="list-cubes">List All Cubes</option>
                                    <option value="count-triples">Count Total Triples</option>
                                    <option value="preview-single">Preview Single Cube</option>
                                    <option value="preview-deletions">Preview Versions to Delete</option>
                                </optgroup>
                                <optgroup label="Orphan Detection">
                                    <option value="find-orphans-summary">Find All Orphans - Summary</option>
                                    <option value="find-orphan-observations">Find Orphan Observations</option>
                                    <option value="find-orphan-sets">Find Orphan Observation Sets</option>
                                </optgroup>
                                <optgroup label="Write Queries (DESTRUCTIVE)">
                                    <option value="delete-single">Delete Single Cube Version</option>
                                    <option value="delete-old-versions">Delete Old Versions (Keep Newest 2)</option>
                                    <option value="delete-orphans">Delete All Orphans</option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="query-type-radio">Query Type</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="query-type" value="select" checked>
                                    <span>SELECT (Read)</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="query-type" value="update">
                                    <span>UPDATE (Write/Delete)</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>SPARQL Query</h3>

                        <textarea id="query-text" class="query-textarea" rows="15" spellcheck="false" placeholder="Enter your SPARQL query here..."></textarea>

                        <div class="button-group">
                            <button id="btn-load-template" class="btn btn-secondary">Load Template</button>
                            <button id="btn-execute-query" class="btn btn-primary">Execute Query</button>
                            <button id="btn-clear-query" class="btn btn-outline">Clear</button>
                        </div>

                        <div id="query-status" class="status-box hidden"></div>
                    </div>

                    <div class="card" id="query-results-card" style="display: none;">
                        <h3>Query Results</h3>
                        <div class="results-header">
                            <span id="results-count"></span>
                            <span id="results-time"></span>
                        </div>
                        <div id="query-results" class="query-results"></div>
                    </div>
                </section>

                <!-- Backups Section -->
                <section id="section-backups" class="content-section">
                    <div class="section-intro">
                        <p>Manage backups of deleted cube versions. Backups are automatically deleted after 7 days.</p>
                    </div>

                    <div class="card">
                        <h3>Available Backups</h3>

                        <button id="btn-refresh-backups" class="btn btn-primary">Refresh Backup List</button>

                        <div id="backup-list" class="table-container">
                            <p class="placeholder-text">Click "Refresh Backup List" to see available backups</p>
                        </div>
                    </div>

                    <div class="card" id="backup-preview-card" style="display: none;">
                        <h3>Backup Details</h3>

                        <div id="backup-preview-info" class="info-box"></div>

                        <div class="form-group">
                            <label for="restore-target-graph">Target Graph (optional)</label>
                            <input type="text" id="restore-target-graph" placeholder="Leave empty to use original graph">
                        </div>

                        <div class="button-group">
                            <button id="btn-restore-backup" class="btn btn-primary">Restore Backup</button>
                            <button id="btn-export-backup" class="btn btn-secondary">Export as File</button>
                            <button id="btn-delete-backup" class="btn btn-danger">Delete Backup</button>
                        </div>

                        <div id="restore-progress" class="progress-container hidden">
                            <div class="progress-bar">
                                <div id="restore-progress-fill" class="progress-fill"></div>
                            </div>
                            <p id="restore-status" class="status-text"></p>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Import Backup File</h3>
                        <p class="description">Upload a backup file (.zip, .json, or .nt) to restore data. ZIP files contain complete backup information including metadata and orphan triples.</p>

                        <div class="upload-area" id="backup-upload-area">
                            <div class="upload-icon">&#128451;</div>
                            <p>Drag and drop a backup file here, or click to select</p>
                            <input type="file" id="backup-file-input" accept=".zip,.json,.nt,.ntriples" style="display: none;">
                            <button id="btn-select-backup-file" class="btn btn-secondary">Select File</button>
                        </div>

                        <div id="upload-preview" class="info-box hidden">
                            <h4>File Preview</h4>
                            <div id="upload-preview-info"></div>
                            <div class="form-group">
                                <label for="import-target-graph">Target Graph (optional)</label>
                                <input type="text" id="import-target-graph" placeholder="Leave empty to use graph from metadata">
                            </div>
                            <div class="button-group">
                                <button id="btn-import-backup" class="btn btn-primary">Import to Triplestore</button>
                                <button id="btn-cancel-import" class="btn btn-secondary">Cancel</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Documentation Section -->
                <section id="section-documentation" class="content-section">
                    <div class="section-intro">
                        <p>Learn how the cleanup process works and understand the SPARQL queries used.</p>
                    </div>

                    <div class="doc-nav">
                        <button class="doc-nav-btn active" data-doc="overview">Overview</button>
                        <button class="doc-nav-btn" data-doc="version-detection">Version Detection</button>
                        <button class="doc-nav-btn" data-doc="ranking">Ranking Algorithm</button>
                        <button class="doc-nav-btn" data-doc="deletion">Deletion Process</button>
                        <button class="doc-nav-btn" data-doc="backup">Backup & Restore</button>
                    </div>

                    <div class="doc-content">
                        <div class="doc-panel active" id="doc-overview">
                            <div class="card">
                                <h3>How LINDAS Cube Manager Works</h3>

                                <p>LINDAS Cube Manager is a tool for managing SPARQL triplestore data, specifically designed to clean up old cube versions from LINDAS (Linked Data Service) while preserving the newest 2 versions of each cube.</p>

                                <h4>Key Features</h4>
                                <ul class="doc-list">
                                    <li><strong>Dry Run Mode:</strong> Preview what would be deleted without making any changes. Safe for testing.</li>
                                    <li><strong>Execute Mode:</strong> Actually perform the deletions after confirming the preview.</li>
                                    <li><strong>Deletion Wizard:</strong> Step-by-step workflow to identify and delete old versions with selective cube deletion.</li>
                                    <li><strong>Query Editor:</strong> Execute custom SPARQL queries with templates.</li>
                                    <li><strong>Automatic Backups:</strong> All deletions create a consolidated backup ZIP before deletion starts.</li>
                                </ul>

                                <h4>Workflow Overview</h4>
                                <div class="workflow-diagram">
                                    <div class="workflow-step">
                                        <span class="step-num">1</span>
                                        <span class="step-text">Connect to Triplestore</span>
                                    </div>
                                    <span class="workflow-arrow">&#8594;</span>
                                    <div class="workflow-step">
                                        <span class="step-num">2</span>
                                        <span class="step-text">Download Data (Optional)</span>
                                    </div>
                                    <span class="workflow-arrow">&#8594;</span>
                                    <div class="workflow-step">
                                        <span class="step-num">3</span>
                                        <span class="step-text">Run Deletion Wizard</span>
                                    </div>
                                    <span class="workflow-arrow">&#8594;</span>
                                    <div class="workflow-step">
                                        <span class="step-num">4</span>
                                        <span class="step-text">Verify & Export</span>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <h3>Cube URI Structure</h3>

                                <p>LINDAS cubes follow a versioned URI pattern:</p>
                                <pre class="code-block">https://energy.ld.admin.ch/sfoe/{cube_name}/{version_number}</pre>

                                <p>Example:</p>
                                <ul class="doc-list">
                                    <li><code>https://energy.ld.admin.ch/sfoe/bfe_ogd18_gebaeudeprogramm_co2wirkung/7</code> - Version 7</li>
                                    <li><code>https://energy.ld.admin.ch/sfoe/bfe_ogd18_gebaeudeprogramm_co2wirkung/1</code> - Version 1</li>
                                </ul>
                            </div>
                        </div>

                        <div class="doc-panel" id="doc-version-detection">
                            <div class="card">
                                <h3>Version Detection</h3>

                                <p>The system extracts version numbers using SPARQL regex pattern matching:</p>

                                <pre class="code-block sparql">BIND(REPLACE(STR(?cube), "^.*/([^/]+)/([0-9]+)$", "$2") AS ?version)
BIND(REPLACE(STR(?cube), "^(.*/[^/]+)/[0-9]+$", "$1") AS ?baseCube)</pre>

                                <h4>How it Works</h4>
                                <ol class="doc-list numbered">
                                    <li>The regex <code>^.*/([0-9]+)/?$</code> captures the numeric suffix as the version</li>
                                    <li>Everything before the version number is extracted as the base cube identifier</li>
                                    <li>Cubes are then grouped by their base URI</li>
                                </ol>

                                <h4>Query: List All Versions</h4>
                                <pre class="code-block sparql">PREFIX cube: &lt;https://cube.link/&gt;
PREFIX xsd: &lt;http://www.w3.org/2001/XMLSchema#&gt;

SELECT ?baseCube ?cube ?version
WHERE {
  GRAPH &lt;GRAPH_URI&gt; {
    ?cube a cube:Cube .
    BIND(REPLACE(STR(?cube), "^(.*/[^/]+)/[0-9]+/?$", "$1") AS ?baseCube)
    BIND(xsd:integer(REPLACE(STR(?cube), "^.*/([0-9]+)/?$", "$1")) AS ?version)
  }
}
ORDER BY ?baseCube DESC(?version)</pre>
                            </div>
                        </div>

                        <div class="doc-panel" id="doc-ranking">
                            <div class="card">
                                <h3>Ranking Algorithm</h3>

                                <p>The core algorithm determines which versions to keep or delete:</p>

                                <pre class="code-block">Rank = (Number of newer versions) + 1

Rank 1-2: KEEP (newest two versions)
Rank 3+:  DELETE (older versions)</pre>

                                <h4>Example with 7 Versions</h4>
                                <table class="doc-table">
                                    <thead>
                                        <tr>
                                            <th>Version</th>
                                            <th>Newer Versions</th>
                                            <th>Rank</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="keep-row">
                                            <td>7</td>
                                            <td>0</td>
                                            <td>1</td>
                                            <td class="action-keep">KEEP</td>
                                        </tr>
                                        <tr class="keep-row">
                                            <td>6</td>
                                            <td>1 (v7)</td>
                                            <td>2</td>
                                            <td class="action-keep">KEEP</td>
                                        </tr>
                                        <tr class="delete-row">
                                            <td>5</td>
                                            <td>2 (v6, v7)</td>
                                            <td>3</td>
                                            <td class="action-delete">DELETE</td>
                                        </tr>
                                        <tr class="delete-row">
                                            <td>4</td>
                                            <td>3</td>
                                            <td>4</td>
                                            <td class="action-delete">DELETE</td>
                                        </tr>
                                        <tr class="delete-row">
                                            <td>3</td>
                                            <td>4</td>
                                            <td>5</td>
                                            <td class="action-delete">DELETE</td>
                                        </tr>
                                        <tr class="delete-row">
                                            <td>2</td>
                                            <td>5</td>
                                            <td>6</td>
                                            <td class="action-delete">DELETE</td>
                                        </tr>
                                        <tr class="delete-row">
                                            <td>1</td>
                                            <td>6</td>
                                            <td>7</td>
                                            <td class="action-delete">DELETE</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="doc-panel" id="doc-deletion">
                            <div class="card">
                                <h3>Deletion Process</h3>

                                <h4>Cube Structure</h4>
                                <p>A cube consists of multiple components that must all be deleted:</p>

                                <pre class="code-block">cube:Cube
  +-- Metadata (title, dates, creator)
  |     +-- Blank nodes (nested properties)
  |
  +-- cube:observationConstraint --> SHACL Shape
  |     +-- sh:property --> Property shapes
  |           +-- sh:in --> RDF lists
  |
  +-- cube:observationSet --> Observation container
        +-- cube:observation --> Data points (many)</pre>

                                <h4>Three-Step Deletion</h4>
                                <p>To avoid timeouts with large cubes, deletion is performed in three steps:</p>

                                <div class="deletion-steps">
                                    <div class="deletion-step">
                                        <span class="step-badge">1</span>
                                        <div class="step-detail">
                                            <h5>Delete Observations</h5>
                                            <p>Remove observation data points (the bulk of the triples)</p>
                                        </div>
                                    </div>
                                    <div class="deletion-step">
                                        <span class="step-badge">2</span>
                                        <div class="step-detail">
                                            <h5>Delete Observation Links</h5>
                                            <p>Remove the cube:observation property connections</p>
                                        </div>
                                    </div>
                                    <div class="deletion-step">
                                        <span class="step-badge">3</span>
                                        <div class="step-detail">
                                            <h5>Delete Metadata and Shapes</h5>
                                            <p>Remove cube metadata, SHACL shapes, and observation set container</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="doc-panel" id="doc-backup">
                            <div class="card">
                                <h3>Backup & Restore</h3>

                                <h4>Automatic Backup</h4>
                                <p>Before any deletion, the system automatically:</p>
                                <ol class="doc-list numbered">
                                    <li>Exports all triples for the cube using a CONSTRUCT query</li>
                                    <li>Creates a self-contained ZIP file with manifest and data</li>
                                    <li>Stores metadata (cube URI, graph, deletion date, orphan info)</li>
                                </ol>

                                <h4>ZIP Backup Format (v4.1)</h4>
                                <p>Backups are stored as ZIP files containing:</p>
                                <pre class="code-block">backup_{id}.zip
 manifest.json      # Complete metadata for restoration
 data.nt            # Cube data (or data_1.nt, data_2.nt for multi-cube)
 orphans.nt         # Orphan triples (if includeOrphans was true)
 README.txt         # Human-readable backup information</pre>

                                <h4>Manifest Structure</h4>
                                <pre class="code-block">{
  "formatVersion": "4.1",
  "backupId": "...",
  "createdAt": "2026-01-31T...",
  "source": {
    "endpoint": "...",
    "dataset": "...",
    "triplestoreType": "fuseki"
  },
  "graph": { "uri": "..." },
  "cubes": [
    {
      "uri": "...",
      "version": 7,
      "dataFile": "data.nt",
      "tripleCount": 12345
    }
  ],
  "stats": {
    "cubeCount": 1,
    "totalTripleCount": 12345,
    "includesMetadata": true,
    "includesOrphans": true,
    "orphanTripleCount": 150
  },
  "orphans": {
    "included": true,
    "tripleCount": 150,
    "stats": { "ObservationSet": 5, "NodeShape": 2 }
  }
}</pre>

                                <h4>Retention Policy</h4>
                                <p>Backups are automatically deleted after <strong>7 days</strong> to manage storage.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Installation Guide Section -->
                <section id="section-installation" class="content-section">
                    <div class="section-intro">
                        <p>Step-by-step instructions to install and configure local triplestores.</p>
                    </div>

                    <div class="installation-tabs">
                        <button class="install-tab-btn active" data-install="fuseki">Apache Fuseki</button>
                        <button class="install-tab-btn" data-install="stardog">Stardog</button>
                        <button class="install-tab-btn" data-install="graphdb">GraphDB</button>
                        <button class="install-tab-btn" data-install="docker">Docker Compose</button>
                    </div>

                    <div class="installation-content">
                        <div class="install-panel active" id="install-fuseki">
                            <div class="card">
                                <h3>Apache Fuseki Installation</h3>
                                <p class="description">Free, open-source SPARQL server from the Apache Jena project.</p>

                                <h4>Option 1: Docker (Recommended)</h4>
                                <pre class="code-block bash"># Pull and run Fuseki
docker run -d --name fuseki \
  -p 3030:3030 \
  -e ADMIN_PASSWORD=admin \
  stain/jena-fuseki

# Create a dataset
curl -X POST 'http://localhost:3030/$/datasets' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d 'dbName=lindas&dbType=tdb2'</pre>

                                <h4>Option 2: Manual Installation</h4>
                                <ol class="install-steps">
                                    <li>
                                        <strong>Download Apache Jena Fuseki</strong>
                                        <p>Download from <a href="https://jena.apache.org/download/" target="_blank">Apache Jena Downloads</a></p>
                                    </li>
                                    <li>
                                        <strong>Extract the Archive</strong>
                                        <pre class="code-block bash">tar xzf apache-jena-fuseki-*.tar.gz
cd apache-jena-fuseki-*</pre>
                                    </li>
                                    <li>
                                        <strong>Start the Server</strong>
                                        <pre class="code-block bash"># In-memory database (data lost on restart)
./fuseki-server --mem /lindas

# Persistent database
./fuseki-server --tdb2 --loc=./data /lindas</pre>
                                    </li>
                                    <li>
                                        <strong>Verify Installation</strong>
                                        <p>Open <a href="http://localhost:3030" target="_blank">http://localhost:3030</a> in your browser</p>
                                    </li>
                                </ol>

                                <div class="config-summary">
                                    <h4>Configuration Summary</h4>
                                    <table class="config-table">
                                        <tr><th>Endpoint</th><td>http://localhost:3030</td></tr>
                                        <tr><th>Query Path</th><td>/{dataset}/query</td></tr>
                                        <tr><th>Update Path</th><td>/{dataset}/update</td></tr>
                                        <tr><th>Default Dataset</th><td>lindas</td></tr>
                                        <tr><th>Authentication</th><td>None (local)</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="install-panel" id="install-stardog">
                            <div class="card">
                                <h3>Stardog Installation</h3>
                                <p class="description">Enterprise knowledge graph platform with free tier available.</p>

                                <div class="warning-banner">
                                    <span class="warning-icon">&#9888;</span>
                                    <div>
                                        <p><strong>License Required:</strong> Stardog will NOT start without a valid license file.</p>
                                        <p style="margin-top: 0.5rem;"><strong>To get a FREE license:</strong></p>
                                        <ol style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                                            <li>Go to <a href="https://www.stardog.com/get-started/" target="_blank">stardog.com/get-started</a></li>
                                            <li>Click "Get Started Free" and create an account</li>
                                            <li>Download the license file (<code>stardog-license-key.bin</code>)</li>
                                            <li>Place it in your Stardog data directory before starting</li>
                                        </ol>
                                        <p style="margin-top: 0.5rem;"><em>If you want a license-free option, use Apache Fuseki instead.</em></p>
                                    </div>
                                </div>

                                <h4>Option 1: Docker</h4>
                                <pre class="code-block bash"># Step 1: Create data directory
mkdir -p stardog-data

# Step 2: Copy your license file (REQUIRED!)
cp stardog-license-key.bin stardog-data/

# Step 3: Run Stardog
docker run -d --name stardog \
  -p 5820:5820 \
  -v $(pwd)/stardog-data:/var/opt/stardog \
  stardog/stardog:latest

# Step 4: Wait for startup, then create a database
sleep 30
docker exec stardog \
  /opt/stardog/bin/stardog-admin db create -n lindas</pre>

                                <h4>Option 2: Manual Installation</h4>
                                <ol class="install-steps">
                                    <li>Download from <a href="https://www.stardog.com/get-started/" target="_blank">Stardog Get Started</a></li>
                                    <li>Install and add license file to <code>$STARDOG_HOME</code></li>
                                    <li>Start: <code>stardog-admin server start</code></li>
                                    <li>Create database: <code>stardog-admin db create -n lindas</code></li>
                                </ol>

                                <div class="config-summary">
                                    <h4>Configuration Summary</h4>
                                    <table class="config-table">
                                        <tr><th>Endpoint</th><td>http://localhost:5820</td></tr>
                                        <tr><th>Query Path</th><td>/{database}/query</td></tr>
                                        <tr><th>Update Path</th><td>/{database}/update</td></tr>
                                        <tr><th>Default Database</th><td>lindas</td></tr>
                                        <tr><th>Default Username</th><td>admin</td></tr>
                                        <tr><th>Default Password</th><td>admin</td></tr>
                                    </table>
                                </div>

                                <div class="limits-box">
                                    <h4>Free Edition Limits</h4>
                                    <ul>
                                        <li>Max 25 databases</li>
                                        <li>Max 10GB data</li>
                                        <li>Max 1 hour query time</li>
                                    </ul>
                                </div>

                                <div class="warning-banner" style="background-color: #e8f4f8; border-color: #5bc0de;">
                                    <span class="warning-icon" style="color: #5bc0de;">&#9432;</span>
                                    <div>
                                        <p><strong>Stardog Cloud Users:</strong> SSO credentials do NOT work for API access!</p>
                                        <p style="margin-top: 0.5rem;">To create API credentials:</p>
                                        <ol style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                                            <li>Go to <a href="https://cloud.stardog.com" target="_blank">cloud.stardog.com</a> and log in with SSO</li>
                                            <li>Click your connection endpoint</li>
                                            <li>Open <strong>Stardog Studio</strong></li>
                                            <li>Navigate to <strong>Security</strong> (cog icon)</li>
                                            <li>Click <strong>+</strong> in the "USERS" pane</li>
                                            <li>Create a new user with username/password</li>
                                            <li>Use those credentials (not SSO) to connect</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="install-panel" id="install-graphdb">
                            <div class="card">
                                <h3>GraphDB Installation</h3>
                                <p class="description">RDF database with reasoning capabilities from Ontotext.</p>

                                <h4>Option 1: Docker (Recommended)</h4>
                                <pre class="code-block bash"># Run GraphDB Free
docker run -d --name graphdb \
  -p 7200:7200 \
  ontotext/graphdb:free

# Access the web interface to create a repository
# http://localhost:7200</pre>

                                <h4>Option 2: Manual Installation</h4>
                                <ol class="install-steps">
                                    <li>Download from <a href="https://www.ontotext.com/products/graphdb/download/" target="_blank">GraphDB Download</a></li>
                                    <li>Run the installer for your OS</li>
                                    <li>Access at <code>http://localhost:7200</code></li>
                                    <li>Create repository via web interface</li>
                                </ol>

                                <div class="config-summary">
                                    <h4>Configuration Summary</h4>
                                    <table class="config-table">
                                        <tr><th>Endpoint</th><td>http://localhost:7200</td></tr>
                                        <tr><th>Query Path</th><td>/repositories/{repository}</td></tr>
                                        <tr><th>Update Path</th><td>/repositories/{repository}/statements</td></tr>
                                        <tr><th>Default Repository</th><td>test</td></tr>
                                        <tr><th>Authentication</th><td>None (local)</td></tr>
                                    </table>
                                </div>

                                <div class="limits-box">
                                    <h4>Free Edition Limits</h4>
                                    <ul>
                                        <li>Max 2 queries/second</li>
                                        <li>Max 1 concurrent query</li>
                                        <li>No cluster support</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="install-panel" id="install-docker">
                            <div class="card">
                                <h3>Docker Compose Setup</h3>
                                <p class="description">Run all three triplestores together using Docker Compose.</p>

                                <h4>docker-compose.yml</h4>
                                <pre class="code-block yaml">version: '3.8'

services:
  fuseki:
    image: stain/jena-fuseki
    container_name: fuseki
    ports:
      - "3030:3030"
    environment:
      - ADMIN_PASSWORD=admin
    volumes:
      - fuseki-data:/fuseki

  graphdb:
    image: ontotext/graphdb:free
    container_name: graphdb
    ports:
      - "7200:7200"
    volumes:
      - graphdb-data:/opt/graphdb/home

  # Note: Stardog requires a license file
  # stardog:
  #   image: stardog/stardog:latest
  #   container_name: stardog
  #   ports:
  #     - "5820:5820"
  #   volumes:
  #     - ./stardog-license-key.bin:/var/opt/stardog/stardog-license-key.bin
  #     - stardog-data:/var/opt/stardog

volumes:
  fuseki-data:
  graphdb-data:
  # stardog-data:</pre>

                                <h4>Usage</h4>
                                <pre class="code-block bash"># Start all services
docker-compose up -d

# Check status
docker-compose ps

# View logs
docker-compose logs -f

# Stop all services
docker-compose down</pre>

                                <h4>Endpoints After Setup</h4>
                                <table class="config-table">
                                    <tr><th>Fuseki</th><td><a href="http://localhost:3030" target="_blank">http://localhost:3030</a></td></tr>
                                    <tr><th>GraphDB</th><td><a href="http://localhost:7200" target="_blank">http://localhost:7200</a></td></tr>
                                    <tr><th>Stardog</th><td><a href="http://localhost:5820" target="_blank">http://localhost:5820</a> (requires license)</td></tr>
                                </table>
                            </div>

                            <div class="card">
                                <h3>Running the Web Application</h3>

                                <h4>Prerequisites</h4>
                                <ul class="install-list">
                                    <li>Node.js v16 or later</li>
                                    <li>npm (comes with Node.js)</li>
                                </ul>

                                <h4>Installation</h4>
                                <pre class="code-block bash"># Navigate to web-app directory
cd web-app

# Install dependencies
npm install

# Start the application
npm start

# Or for development with auto-reload
npm run dev</pre>

                                <h4>Access</h4>
                                <p>Open <a href="http://localhost:3001" target="_blank">http://localhost:3001</a> in your browser.</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script src="app.js?v=2"></script>
</body>
</html>
