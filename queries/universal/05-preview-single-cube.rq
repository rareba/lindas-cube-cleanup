# Query 5: PREVIEW deletion of a single cube - count all triples
# PARAMETERS:
#   - Replace GRAPH_URI with the target graph
#   - Replace CUBE_URI with the cube to preview
# This query counts all triples that would be deleted without making changes.
# Run this BEFORE the delete query to verify what will be removed.

PREFIX cube: <https://cube.link/>
PREFIX sh: <http://www.w3.org/ns/shacl#>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX schema: <http://schema.org/>

SELECT
    ?cube
    ?title
    (COUNT(DISTINCT ?metaTriple) AS ?metadataTriples)
    (COUNT(DISTINCT ?shapeTriple) AS ?shapeTriples)
    (COUNT(DISTINCT ?propTriple) AS ?propertyShapeTriples)
    (COUNT(DISTINCT ?setTriple) AS ?observationSetTriples)
    (COUNT(DISTINCT ?obsTriple) AS ?observationTriples)
    ((COUNT(DISTINCT ?metaTriple) + COUNT(DISTINCT ?shapeTriple) + COUNT(DISTINCT ?propTriple) + COUNT(DISTINCT ?setTriple) + COUNT(DISTINCT ?obsTriple)) AS ?totalTriples)
WHERE {
    GRAPH <GRAPH_URI> {
        BIND(<CUBE_URI> AS ?cube)
        ?cube rdf:type cube:Cube .

        # Get cube title
        OPTIONAL { ?cube schema:name ?title . FILTER(lang(?title) = "en" || lang(?title) = "") }

        # Metadata triples (direct properties + blank nodes)
        OPTIONAL {
            ?cube ?p1 ?metaLevel1 .
            BIND(CONCAT(STR(?cube), "|", STR(?p1), "|", STR(?metaLevel1)) AS ?metaTriple)
        }

        # Shape triples
        OPTIONAL {
            ?cube cube:observationConstraint ?shape .
            ?shape ?shapeP ?shapeO .
            BIND(CONCAT(STR(?shape), "|", STR(?shapeP), "|", STR(?shapeO)) AS ?shapeTriple)
        }

        # Property shape triples (SHACL property definitions)
        OPTIONAL {
            ?cube cube:observationConstraint/sh:property ?property .
            ?property (<>|!<>)* ?propertyS .
            ?propertyS ?propertyP ?propertyO .
            BIND(CONCAT(STR(?propertyS), "|", STR(?propertyP), "|", STR(?propertyO)) AS ?propTriple)
        }

        # Observation set triples
        OPTIONAL {
            ?cube cube:observationSet ?set .
            ?set ?setP ?setO .
            BIND(CONCAT(STR(?set), "|", STR(?setP), "|", STR(?setO)) AS ?setTriple)
        }

        # Observation triples (the actual data)
        OPTIONAL {
            ?cube cube:observationSet ?obsSet .
            ?obsSet cube:observation ?obs .
            ?obs ?obsP ?obsO .
            BIND(CONCAT(STR(?obs), "|", STR(?obsP), "|", STR(?obsO)) AS ?obsTriple)
        }
    }
}
GROUP BY ?cube ?title
