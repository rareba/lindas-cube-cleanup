# Query 2: Count versions per cube base URI
# PARAMETER: Replace GRAPH_URI with the target graph
# Shows cubes with more than 2 versions (cleanup candidates)

PREFIX cube: <https://cube.link/>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

SELECT ?baseCube (COUNT(DISTINCT ?cube) AS ?versionCount) (GROUP_CONCAT(DISTINCT ?version; separator=", ") AS ?versions)
WHERE {
  GRAPH <GRAPH_URI> {
    ?cube a cube:Cube .

    BIND(REPLACE(STR(?cube), "^.*/([^/]+)/([0-9]+)$", "$2") AS ?versionStr)
    BIND(IF(REGEX(STR(?cube), "^.*/[^/]+/[0-9]+$"), ?versionStr, "0") AS ?version)

    BIND(REPLACE(STR(?cube), "^(.*/[^/]+)/[0-9]+$", "$1") AS ?baseCubeStr)
    BIND(IF(REGEX(STR(?cube), "^.*/[^/]+/[0-9]+$"), ?baseCubeStr, STR(?cube)) AS ?baseCube)
  }
}
GROUP BY ?baseCube
HAVING (COUNT(DISTINCT ?cube) > 2)
ORDER BY DESC(?versionCount)
