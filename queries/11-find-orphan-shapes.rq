# Query 11: Find orphan shapes in the SFOE graph
# An orphan shape is a SHACL NodeShape that exists in the graph but is NOT
# referenced by any cube via cube:observationConstraint.
# This typically happens after cube versions are deleted - the shapes they
# referenced are left behind as unreferenced data.
#
# Purpose: Discovery - identify orphan shapes before cleanup
# Safety: This is a read-only SELECT query, no data is modified.

PREFIX cube: <https://cube.link/>
PREFIX sh: <http://www.w3.org/ns/shacl#>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX schema: <http://schema.org/>

SELECT
  ?shape
  ?shapeType
  (COUNT(DISTINCT ?propShape) AS ?propertyShapeCount)
  (COUNT(DISTINCT ?allTriple) AS ?estimatedTriples)
WHERE {
  GRAPH <https://lindas.admin.ch/sfoe/cube> {
    # Find all SHACL NodeShapes in the graph
    # Shapes are identified by either:
    #   - Being typed as sh:NodeShape
    #   - Being the object of a cube:observationConstraint predicate (which we exclude below)
    #   - Having sh:property predicates (characteristic of shapes)
    ?shape a sh:NodeShape .

    # Exclude shapes that ARE referenced by a remaining cube
    FILTER NOT EXISTS {
      ?anyCube cube:observationConstraint ?shape .
      ?anyCube a cube:Cube .
    }

    # Get the shape type for reporting
    OPTIONAL { ?shape rdf:type ?shapeType }

    # Count associated property shapes
    OPTIONAL { ?shape sh:property ?propShape }

    # Count all triples reachable from this shape (shape + property shapes + nested)
    OPTIONAL {
      {
        # Direct shape triples
        ?shape ?sp ?so .
        BIND(CONCAT(STR(?shape), "|", STR(?sp), "|", STR(?so)) AS ?allTriple)
      }
      UNION
      {
        # Property shape triples
        ?shape sh:property ?ps .
        ?ps ?psp ?pso .
        BIND(CONCAT(STR(?ps), "|", STR(?psp), "|", STR(?pso)) AS ?allTriple)
      }
      UNION
      {
        # RDF list nodes in property shapes (sh:in lists)
        ?shape sh:property ?ps .
        ?ps sh:in ?list .
        ?list rdf:rest*/rdf:first ?item .
        ?list ?lp ?lo .
        BIND(CONCAT(STR(?list), "|", STR(?lp), "|", STR(?lo)) AS ?allTriple)
      }
    }
  }
}
GROUP BY ?shape ?shapeType
ORDER BY ?shape
