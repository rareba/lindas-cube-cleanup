# Query 13: DELETE orphan shapes and all their nested triples
# An orphan shape is a SHACL NodeShape in the graph that is NOT referenced
# by any remaining cube via cube:observationConstraint.
#
# WARNING: This is a destructive operation!
# Always run query 11 (find orphan shapes) and query 12 (preview triples)
# BEFORE executing this delete to verify what will be removed.
#
# This query deletes:
#   1. The shape node and all its direct triples
#   2. All property shapes linked via sh:property
#   3. All RDF list nodes inside property shapes (sh:in value lists)
#   4. Any incoming references to the shape
#
# Uses the same UNION pattern as queries 06 and 09 for consistency.
# Uses BIND pattern for Stardog compatibility.

PREFIX cube: <https://cube.link/>
PREFIX sh: <http://www.w3.org/ns/shacl#>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>

DELETE {
  GRAPH <https://lindas.admin.ch/sfoe/cube> {
    ?s ?p ?o .
  }
}
WHERE {
  GRAPH <https://lindas.admin.ch/sfoe/cube> {
    # Identify orphan shapes: sh:NodeShape not referenced by any cube
    ?orphanShape a sh:NodeShape .
    FILTER NOT EXISTS {
      ?anyCube cube:observationConstraint ?orphanShape .
      ?anyCube a cube:Cube .
    }

    {
      # Shape's own outgoing triples (rdf:type, sh:closed, sh:property links, etc.)
      ?orphanShape ?p ?o .
      BIND(?orphanShape AS ?s)
    }
    UNION
    {
      # Incoming references to the shape (anything pointing TO this shape)
      ?s ?p ?orphanShape .
      BIND(?orphanShape AS ?o)
    }
    UNION
    {
      # Property shape outgoing triples
      # Each shape has multiple sh:property links to property shapes
      # Each property shape has its own constraints (sh:path, sh:datatype, etc.)
      ?orphanShape sh:property ?propShape .
      ?propShape ?p ?o .
      BIND(?propShape AS ?s)
    }
    UNION
    {
      # RDF list nodes in property shapes (sh:in value lists)
      # Some property shapes define allowed values via sh:in which uses RDF lists
      # The list is a chain of rdf:first/rdf:rest nodes that all need cleanup
      ?orphanShape sh:property ?propShape .
      ?propShape sh:in ?list .
      ?list rdf:rest*/rdf:first ?item .
      ?list ?p ?o .
      BIND(?list AS ?s)
    }
  }
}
