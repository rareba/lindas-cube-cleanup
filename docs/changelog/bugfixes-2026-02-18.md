# Bug Fixes - 2026-02-18

## Summary

Code review identified 11 bugs (5 critical, 6 important) affecting API contracts,
security, and reliability. All 11 have been fixed in this commit.

## Critical Fixes

### 1. `/api/lindas/all-graphs` response contract (server.js)
**Problem**: Endpoint returned raw SPARQL JSON `{ results: { bindings: [...] } }` but
the frontend expected `{ graphs: [{ uri }] }`. The "Load Graphs" dropdown always showed
"No graphs found".
**Fix**: Transform SPARQL bindings into the expected `{ graphs }` shape before responding.

### 2. `/api/lindas/cubes` response contract (server.js)
**Problem**: Same pattern - raw SPARQL result vs expected `{ cubes: [...] }`. The
"Download All Cubes" feature always errored with "No cubes found".
**Fix**: Map SPARQL bindings to `{ cubes: [{ cube, title, version, baseCube, dateCreated }] }`.

### 3. Field name mismatch in download pipeline (app.js)
**Problem**: Server returned `{ triples: ... }` but frontend read `downloadResult.ntriples`
(undefined). The import endpoint then received `undefined` as data, causing a TypeError.
**Fix**: Changed `downloadResult.ntriples` to `downloadResult.triples` in app.js.

### 4. Hardcoded `versionsToKeep` (server.js + app.js)
**Problem**: Server always used `rank <= 2` regardless of the UI's configurable
`versionsToKeep` setting. Users who set 3+ versions to keep still got version 3 marked
for deletion.
**Fix**: Frontend now sends `versionsToKeep` in the request body. Both
`/api/cubes/count-versions` (HAVING clause) and `/api/cubes/identify-deletions`
(rank comparison) use the parameter.

### 5. Backup cleanup never fires (server.js)
**Problem**: `cleanupOldBackups()` checked `file.includes('_backup_')` but backup files
are created as `backup_*.zip` (starting with `backup_`, not containing `_backup_`).
Zero files ever matched, so backups accumulated indefinitely.
**Fix**: Changed filter to `file.startsWith('backup_')`.

## Security Fixes

### 6. SPARQL injection via `searchTerm` (server.js)
**Problem**: User-supplied `searchTerm` was interpolated directly into a SPARQL query
string without escaping, allowing injection attacks.
**Fix**: Escape backslash and double-quote characters before interpolation.

### 7. SPARQL injection via `offset`/`limit` (server.js)
**Problem**: String-typed `offset` and `limit` from request body were directly
interpolated into SPARQL, allowing injection.
**Fix**: Parse as integers with `parseInt()`, clamp to valid ranges.

### 8. Missing auth guards on restore/import (server.js)
**Problem**: Three endpoints (`/api/backup/restore`, `/api/backup/import`,
`/api/backup/restore-to`) did not use `requireDestructiveAccess` middleware, allowing
data writes even when `ENABLE_DESTRUCTIVE_API=false`.
**Fix**: Added `requireDestructiveAccess` middleware to all three.

### 10. Dataset creation parameter injection + SSRF (server.js)
**Problem**: `datasetName` was interpolated directly into a form-encoded body without
`encodeURIComponent()`. The `endpoint` parameter in the legacy endpoint was an
unvalidated SSRF vector.
**Fix**: Added `encodeURIComponent()` for `datasetName` in both endpoints. Added
localhost validation for the legacy endpoint.

## Reliability Fixes

### 9. Orphan cleanup wizard hang (app.js)
**Problem**: `waitForOrphanCleanupDecision()` returned a Promise that never resolved if
the expected DOM buttons were absent, freezing the wizard permanently.
**Fix**: Resolve immediately with `skip` if no buttons exist. Added 5-minute safety
timeout as a fallback.

## Files Modified

- `web-app/server.js` - Bugs 1, 2, 4, 5, 6, 7, 8, 10, 11
- `web-app/public/app.js` - Bugs 3, 4, 9
- `changelog.md` - Updated with all fixes
